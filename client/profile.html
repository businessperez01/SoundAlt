<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - SoundAlt</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/particles.css">
</head>
<body>
    <div id="particles-js"></div>
    <nav class="navbar">
        <div class="nav-brand">
            <a href="/">SoundAlt</a>
        </div>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/upload" id="uploadLink">Upload</a>
            <a href="/profile" class="active">Profile</a>
            <button id="logoutBtn">Logout</button>
        </div>
    </nav>

    <main id="app">
        <div class="content-container">
            <div class="profile-header">
                <h2>My Sounds</h2>
            </div>

            <div class="sounds-grid" id="userSounds">
                <!-- User's sounds will be loaded here -->
            </div>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <h3>Edit Sound</h3>
                <form id="editForm">
                    <input type="hidden" id="editSoundId">
                    <div class="form-group">
                        <label for="editTitle">Title</label>
                        <input type="text" id="editTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="editTags">Tags (comma separated)</label>
                        <input type="text" id="editTags">
                    </div>
                    <div id="editErrorMessage" class="error-message"></div>
                    <div class="modal-buttons">
                        <button type="submit" class="button">Save Changes</button>
                        <button type="button" class="button cancel-button" onclick="closeEditModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="js/particles-config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Check if user is logged in
        if (!localStorage.getItem('token')) {
            window.location.href = '/login';
        }

        // Load user's sounds
        async function loadUserSounds() {
            try {
                const response = await fetch('/api/sounds/user', {
                    headers: {
                        'x-auth-token': localStorage.getItem('token')
                    }
                });

                const sounds = await response.json();
                const soundsGrid = document.getElementById('userSounds');
                
                if (sounds.length === 0) {
                    soundsGrid.innerHTML = '<p class="no-sounds">You haven\'t uploaded any sounds yet.</p>';
                    return;
                }

                soundsGrid.innerHTML = sounds.map(sound => `
                    <div class="sound-card" id="card-${sound._id}">
                        <h3>${sound.title}</h3>
                        <div class="player-container">
                            <button class="button play-button" onclick="togglePlay('${sound._id}', '${sound.fileUrl}')">
                                <i class="fas fa-play" id="play-icon-${sound._id}"></i> 
                                <span id="play-text-${sound._id}">Play</span>
                            </button>
                            <div class="progress-container">
                                <div class="progress-bar" id="progress-${sound._id}">
                                    <div class="progress-fill"></div>
                                </div>
                                <div class="time-display">
                                    <span id="current-time-${sound._id}">0:00</span>
                                    <span id="duration-${sound._id}">0:00</span>
                                </div>
                            </div>
                        </div>
                        <div class="sound-actions">
                            <button class="button edit-button" onclick="openEditModal('${sound._id}', '${sound.title}', '${sound.tags.join(',')}')">Edit</button>
                            <button class="button delete-button" onclick="deleteSound('${sound._id}')">Delete</button>
                        </div>
                        <div class="tags">
                            ${sound.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading sounds:', error);
            }
        }

        // Audio player management
        let currentAudio = null;
        let currentSoundId = null;

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function updateProgress(soundId, audio) {
            const progressBar = document.getElementById(`progress-${soundId}`);
            const currentTime = document.getElementById(`current-time-${soundId}`);
            const duration = document.getElementById(`duration-${soundId}`);
            const card = document.getElementById(`card-${soundId}`);
            
            // Update progress bar
            const progress = (audio.currentTime / audio.duration) * 100;
            progressBar.style.setProperty('--progress', `${progress}%`);
            progressBar.querySelector('.progress-fill').style.width = `${progress}%`;
            
            // Update time display
            currentTime.textContent = formatTime(audio.currentTime);
            duration.textContent = formatTime(audio.duration);
        }

        function togglePlay(soundId, url) {
            const playIcon = document.getElementById(`play-icon-${soundId}`);
            const playText = document.getElementById(`play-text-${soundId}`);
            const card = document.getElementById(`card-${soundId}`);

            // If there's already a sound playing
            if (currentAudio) {
                currentAudio.pause();
                // Reset previous sound's UI
                const prevIcon = document.getElementById(`play-icon-${currentSoundId}`);
                const prevText = document.getElementById(`play-text-${currentSoundId}`);
                const prevCard = document.getElementById(`card-${currentSoundId}`);
                prevIcon.className = 'fas fa-play';
                prevText.textContent = 'Play';
                prevCard.classList.remove('playing');
                
                // If clicking the same sound, just stop it
                if (currentSoundId === soundId) {
                    currentAudio = null;
                    currentSoundId = null;
                    return;
                }
            }

            // Play new sound
            const audio = new Audio(url);
            audio.addEventListener('timeupdate', () => updateProgress(soundId, audio));
            audio.addEventListener('ended', () => {
                playIcon.className = 'fas fa-play';
                playText.textContent = 'Play';
                card.classList.remove('playing');
                currentAudio = null;
                currentSoundId = null;
                // Reset progress bar and time display
                const progressBar = document.getElementById(`progress-${soundId}`);
                progressBar.style.setProperty('--progress', '0%');
                progressBar.querySelector('.progress-fill').style.width = '0%';
                document.getElementById(`current-time-${soundId}`).textContent = '0:00';
            });
            
            audio.play();
            currentAudio = audio;
            currentSoundId = soundId;
            
            // Update UI
            playIcon.className = 'fas fa-pause';
            playText.textContent = 'Pause';
            card.classList.add('playing');

            // Initialize duration once it's loaded
            audio.addEventListener('loadedmetadata', () => {
                document.getElementById(`duration-${soundId}`).textContent = formatTime(audio.duration);
            });
        }

        // Add click handler for progress bar
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('progress-bar') && currentAudio && currentSoundId) {
                const progressBar = e.target;
                const rect = progressBar.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const width = rect.width;
                const percentage = x / width;
                
                currentAudio.currentTime = currentAudio.duration * percentage;
                updateProgress(currentSoundId, currentAudio);
            }
        });

        // Delete sound function
        async function deleteSound(soundId) {
            if (!confirm('Are you sure you want to delete this sound?')) {
                return;
            }

            try {
                const response = await fetch(`/api/sounds/${soundId}`, {
                    method: 'DELETE',
                    headers: {
                        'x-auth-token': localStorage.getItem('token')
                    }
                });

                if (response.ok) {
                    loadUserSounds(); // Reload the sounds list
                } else {
                    alert('Failed to delete sound');
                }
            } catch (error) {
                console.error('Error deleting sound:', error);
                alert('An error occurred while deleting the sound');
            }
        }

        // Edit modal functions
        function openEditModal(soundId, title, tags) {
            document.getElementById('editModal').style.display = 'flex';
            document.getElementById('editSoundId').value = soundId;
            document.getElementById('editTitle').value = title;
            document.getElementById('editTags').value = tags;
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editErrorMessage').textContent = '';
        }

        // Handle edit form submission
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const soundId = document.getElementById('editSoundId').value;
            const title = document.getElementById('editTitle').value;
            const tags = document.getElementById('editTags').value;
            const errorMessage = document.getElementById('editErrorMessage');

            try {
                const response = await fetch(`/api/sounds/${soundId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-auth-token': localStorage.getItem('token')
                    },
                    body: JSON.stringify({ title, tags })
                });

                if (response.ok) {
                    closeEditModal();
                    loadUserSounds(); // Reload the sounds list
                } else {
                    const data = await response.json();
                    errorMessage.textContent = data.message || 'Failed to update sound';
                }
            } catch (error) {
                console.error('Error updating sound:', error);
                errorMessage.textContent = 'An error occurred while updating the sound';
            }
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeEditModal();
            }
        }

        // Load sounds when page loads
        loadUserSounds();
    </script>
</body>
</html>
